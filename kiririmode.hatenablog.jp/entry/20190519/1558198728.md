---
Title: gRPC ã§ golang server/node client ã‚’ SSL ã«å¯¾å¿œã•ã›ã‚‹
Category:
- grpc
- golang
- node.js
Date: 2019-05-19T01:58:48+09:00
URL: https://kiririmode.hatenablog.jp/entry/20190519/1558198728
EditURL: https://blog.hatena.ne.jp/kiririmode/kiririmode.hatenablog.jp/atom/entry/17680117127144303697
---

ä»Šå›žã¯ã€gRPC ã§ SSL é€šä¿¡ã‚’è¡ŒãŠã†ã¨æ€ã„ã¾ã™ã€‚
ç’°å¢ƒã¨ã—ã¦ã¯ã€ã‚µãƒ¼ãƒã¯ golangã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ node.js ã¨ã„ã†æ§‹æˆã§ã™ã€‚

[:contents]

# ãƒ«ãƒ¼ãƒˆèªè¨¼å±€ã€è¨¼æ˜Žæ›¸ã‚’ä½œæˆã™ã‚‹ã€‚

SSL é€šä¿¡ã®ãŸã‚ã€ã¾ãšã¯ãƒ«ãƒ¼ãƒˆèªè¨¼å±€ã‚’ä½œæˆã—ã¾ã™ã€‚
ä»Šå›žã¯ mkcert ã‚’ä½¿ã„ã¾ã—ãŸã€‚

[https://github.com/FiloSottile/mkcert:embed]

```tcsh
$ mkcert -install
Created a new local CA at "/Users/kiririmode/Library/Application Support/mkcert" ðŸ’¥
Password:
The local CA is now installed in the system trust store! âš¡ï¸
Warning: "certutil" is not available, so the CA can't be automatically installed in Firefox! âš ï¸
Install "certutil" with "brew install nss" and re-run "mkcert -install" ðŸ‘ˆ
```

ã“ã®æ®µéšŽã§ã€KeyChain ã«ãƒ«ãƒ¼ãƒˆèªè¨¼å±€ã®è¨¼æ˜Žæ›¸ãŒç™»éŒ²ã•ã‚Œã¾ã™ã€‚æ—©ã„!
[f:id:kiririmode:20190519020348p:plain]


æ¬¡ã«ã€è¨¼æ˜Žæ›¸ã‚’ä½œã‚Šã¾ã™ã€‚ ä¾‹ãˆã° `kiririmode.com` ã¨ã„ã†åå‰ãŒå®šç¾©ã•ã‚ŒãŸè¨¼æ˜Žæ›¸ã‚’ä½œã‚‹ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚Œã°è‰¯ã„ã§ã™ã€‚

```tcsh
$ mkcert kiririmode.com
Using the local CA at "/Users/kiririmode/Library/Application Support/mkcert" âœ¨
Warning: the local CA is not installed in the Firefox trust store! âš ï¸
Run "mkcert -install" to avoid verification errors â€¼ï¸

Created a new certificate valid for the following names ðŸ“œ
 - "kiririmode.com"

The certificate is at "./kiririmode.com.pem" and the key at "./kiririmode.com-key.pem" âœ…
```

ã“ã†ã™ã‚‹ã¨ã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«éµã¨è¨¼æ˜Žæ›¸ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã™ã€‚

# golang ã® gRPC ã‚µãƒ¼ãƒã«çµ„ã¿è¾¼ã‚€

golang ã® gRPC ã‚µãƒ¼ãƒã‚’ SSL å¯¾å¿œã«ã™ã‚‹ã®ã¯ç°¡å˜ã§ã€éµã¨è¨¼æ˜Žæ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ [NewServerTLSFromFile](https://godoc.org/google.golang.org/grpc/credentials#NewServerTLSFromFile)ã«æ¸¡ã—ã¦ [`TransportCredentials](https://godoc.org/google.golang.org/grpc/credentials#TransportCredentials) ã‚’ä½œæˆã€ãã‚Œã‚’ `grpc.NewServer` ã«æ¸¡ã™ã ã‘ã§è‰¯ã„ã€‚

```diff
diff --git a/server/main.go b/server/main.go
index a707402..d868a84 100644
--- a/server/main.go
+++ b/server/main.go
@@ -2,6 +2,7 @@
 package main

 import (
+       "google.golang.org/grpc/credentials"
        "google.golang.org/grpc/keepalive"
        "context"
        "log"
@@ -85,7 +86,16 @@ func main() {
        if err != nil {
                log.Fatalf("failed to listen: %v", err)
        }
+
+       creds, err := credentials.NewServerTLSFromFile(
+               "./kiririmode.com.pem",
+               "./kiririmode.com-key.pem",
+       )
+       if err != nil {
+               log.Fatalf("failed to load certificate: %v", err)
+       }
        s := grpc.NewServer(
+               grpc.Creds(creds),
                grpc.KeepaliveEnforcementPolicy(keepalive.EnforcementPolicy{
                        MinTime: 2 * time.Second,
                        PermitWithoutStream: true,
```

ä»¥å‰ã«ç´¹ä»‹ã—ãŸ [grpcurl](https://github.com/fullstorydev/grpcurl) ã¯ TLS ã«ã‚‚å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«ã€`-plaintext` ç„¡ã—ã§å‘¼ã³å‡ºã—ã¦ã€ãã¡ã‚“ã¨å¿œç­”ãŒè¿”å´ã•ã‚Œã‚Œã°æˆåŠŸã§ã™ã€‚

```tcsh
$ grpcurl -import-path protobuf -proto greeter.proto -d '{ "name": "kiririmode" }' kiririmode.com:50050 Greeter.SayHello
{
  "timestamp": "2019-05-18T15:14:09.134940Z",
  "message": "Hello kiririmode"
}
```
ãã®ä»–ã® grpcurl ã®ä½¿ã„æ–¹ã«ã¤ã„ã¦ã¯ã€ã“ã¡ã‚‰ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

[https://kiririmode.hatenablog.jp/entry/20181008/1538984412:embed]

# Node.js client ã‚’ SSL ã«å¯¾å¿œã•ã›ã‚‹

Node.js ã§ `grpc` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½¿ã£ãŸå ´åˆã€ [`grpc.Client`](https://grpc.github.io/grpc/node/grpc.Client.html) ã®ç¬¬2å¼•æ•° `credentials` ãŒ SSL ã®è‚ã«ãªã‚Šã¾ã™ã€‚
ä»Šå›žä½œæˆã—ãŸãƒ«ãƒ¼ãƒˆè¨¼æ˜Žæ›¸ã‚’å¼•æ•°ã«ã—ã¦ä»¥ä¸‹ã®æ§˜ã«å®Ÿè£…ã™ã‚Œã°è‰¯ã„ã§ã™ãŒã€å®Ÿã¯ã“ã‚Œã¯ç­‹ãŒæ‚ªã„ã§ã™ã€‚

```javascript
    const client = new greeter(
        "kiririmode.com:50050",
        grpc.credentials.createSsl(
            fs.readFileSync(
                "/Users/kiririmode//Library/Application Support/mkcert/rootCA.pem"
            )
        ),
        // ä»¥ä¸‹ã¯ keepalive ç”¨è¨­å®šãªã®ã§ã€ä»Šå›žã®ã‚¨ãƒ³ãƒˆãƒªã¨ã¯ç„¡é–¢ä¿‚ */
        {
            "grpc.keepalive_time_ms": 1000,
            "grpc.keepalive_timeout_ms": 2000,
            "grpc.http2.min_time_between_pings_ms": 3000,
            "grpc.http2.max_pings_without_data": 0
        }
    )
```

ç­‹ãŒæ‚ªã„ã®ã¯ã€ãƒ«ãƒ¼ãƒˆèªè¨¼å±€ã®è¨¼æ˜Žæ›¸ã‚’ã‚ã–ã‚ã–æ¸¡ã—ã¦ã„ã‚‹ã¨ã“ã‚ã€‚

é€šå¸¸ãƒ«ãƒ¼ãƒˆèªè¨¼å±€ã¨ã—ã¦ keychain ä¸Šã§ã€Œä¿¡é ¼ã™ã‚‹ã€ã‚ˆã†ã«è¨­å®šã—ãŸã‚‚ã®ã¯ã€Node.js ã§ã‚‚ä¿¡é ¼ã—ã¦ã»ã—ã„ã‚‚ã®ãªã®ã§ã™ãŒã€Node ã ã¨ã€Œã©ã®ãƒ«ãƒ¼ãƒˆèªè¨¼å±€ã‚’ä¿¡ã˜ã‚‹ã®ã‹ã€ã¯ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‚‰ã—ã„ã€‚ã“ã®ãŸã‚ã€è¿½åŠ ã§è‡ªå·±èªè¨¼å±€ã‚’ç«‹ã¦ãŸå ´åˆã¯ã€ã“ã†ã‚„ã£ã¦èªè¨¼å±€ã®è¨¼æ˜Žæ›¸ã‚’æ¸¡ã—ã¦ã‚„ã‚‹ã—ã‹ãªã„ã€‚ã€‚

ã¨æ€ã£ã¦ã„ãŸã‚‰ã€Node.js ã«ã¯ [`NODE_EXTRA_CA_CERTS`](https://nodejs.org/api/cli.html#cli_node_extra_ca_certs_file) ã¨ã„ã†ç’°å¢ƒå¤‰æ•°ã§ã€è¿½åŠ ã§ä¿¡é ¼ã™ã‚‹ãƒ«ãƒ¼ãƒˆèªè¨¼å±€ã®è¨¼æ˜Žæ›¸ã‚’è¨­å®šã§ãã‚‹ã“ã¨ã«æ°—ã¥ãã¾ã—ãŸã€‚
ã“ã‚Œã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€ `createSSL` ã®å¼•æ•°ã¯ç„¡æŒ‡å®šã«ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

```javascript
    const client = new greeter(
        "kiririmode.com:50050",
        grpc.credentials.createSsl(),
        /* ä»¥ä¸‹ã¯ keep-alive ç”¨ã®è¨­å®šãªã®ã§ã€ä»Šå›žã®ã‚¨ãƒ³ãƒˆãƒªã¨ã¯ç„¡é–¢ä¿‚ */
        {
            "grpc.keepalive_time_ms": 1000,
            "grpc.keepalive_timeout_ms": 2000,
            "grpc.http2.min_time_between_pings_ms": 3000,
            "grpc.http2.max_pings_without_data": 0
        }
    )
    client.SayHello({ name: "kiririmode" }, (err, res) => {
        console.log(res)
    })
```

å®Ÿè¡Œã™ã‚‹ã¨ãã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦å®Ÿè¡Œã™ã‚Œã°è‰¯ã„ã§ã—ã‚‡ã†ã€‚

```tcsh
$ NODE_EXTRA_CA_CERTS=~/Library/Application\ Support/mkcert/rootCA.pem npx babel-node index.js
{
  timestamp: { seconds: '1558197855', nanos: 985252000 },
  message: 'Hello kiririmode'
}
```

ãªãŠã€ã“ã®ã‚ˆã†ãªè¨­å®šãŒå¿…è¦ãªã®ã¯ã€ã‚ãã¾ã§ãƒ«ãƒ¼ãƒˆèªè¨¼å±€ã‚’è‡ªåˆ†ã§ä½œã£ãŸã‹ã‚‰ã§ã€ã‚ªãƒ¬ã‚ªãƒ¬è¨¼æ˜Žæ›¸ã‚’ä½œã‚‰ãªã‘ã‚Œã°ã€å¤šãã®å ´åˆã“ã®ã‚ˆã†ãªæŒ‡å®šã¯ä¸è¦ã«ãªã‚‹ã¯ãšã§ã™ã€‚

# node ã®ã‚½ãƒ¼ã‚¹

```javascript
const path = require("path")
const grpc = require("grpc")
const protoLoader = require("@grpc/proto-loader")
const fs = require("fs")

const PROTO_PATH = path.join(__dirname, "greeter.proto")

try {
    const packageDefinition = protoLoader.loadSync(PROTO_PATH, {
        keepCase: false,
        longs: String,
        enums: String,
        defaults: true,
        oneofs: true
    })
    const greeter = grpc.loadPackageDefinition(packageDefinition).Greeter
    const client = new greeter(
        "kiririmode.com:50050",
        grpc.credentials.createSsl(),
        {
            "grpc.keepalive_time_ms": 1000,
            "grpc.keepalive_timeout_ms": 2000,
            "grpc.http2.min_time_between_pings_ms": 3000,
            "grpc.http2.max_pings_without_data": 0
        }
    )
    client.SayHello({ name: "kiririmode" }, (err, res) => {
        console.log(res)
    })
} catch (ex) {
    console.error(ex)
}
```
