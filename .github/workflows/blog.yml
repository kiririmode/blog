name: kiririmode.hatenablog.jp post entry workflow
on:
  push:
    branches:
      - master
    paths:
      - "kiririmode.hatenablog.jp/entry/[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]/*.md"
      - "**/*.sh"

jobs:
  textlint:
    name: Run textlint
    runs-on: ubuntu-latest
    steps:
      # コミットをチェックアウト
      - name: Checkout the commit
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 100

      # 変更されたMarkdownファイルを検出
      - name: Get changed markdown files
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          files: |
            kiririmode.hatenablog.jp/entry/[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]/*.md

      # Node.js環境をセットアップ（変更があった場合のみ）
      - name: Setup Node.js environment
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      # 依存関係のキャッシュ（変更があった場合のみ）
      - name: Cache dependencies
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/cache@v5
        with:
          path: node_modules
          key: node-${{ hashFiles('package-lock.json') }}

      # 依存関係をインストール（変更があった場合のみ）
      - name: Install dependencies
        if: steps.changed-files.outputs.any_changed == 'true'
        run: npm install

      # 変更されたファイルに対してtextlintを実行（変更があった場合のみ）
      - name: Run textlint on changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Running textlint on changed files..."
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Linting: $file"
            npx textlint "$file"
          done

  markdownlint:
    name: Run markdownlint
    runs-on: ubuntu-latest
    steps:
      # コミットをチェックアウト
      - name: Checkout the commit
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 100

      # 変更されたMarkdownファイルを検出
      - name: Get changed markdown files
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          files: |
            kiririmode.hatenablog.jp/entry/[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]/*.md

      # Node.js環境をセットアップ（変更があった場合のみ）
      - name: Setup Node.js environment
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      # 依存関係のキャッシュ（変更があった場合のみ）
      - name: Cache dependencies
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/cache@v5
        with:
          path: node_modules
          key: node-${{ hashFiles('package-lock.json') }}

      # 依存関係をインストール（変更があった場合のみ）
      - name: Install dependencies
        if: steps.changed-files.outputs.any_changed == 'true'
        run: npm install

      # 変更されたファイルに対してmarkdownlintを実行（変更があった場合のみ）
      - name: Run markdownlint on changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Running markdownlint on changed files..."
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Linting: $file"
            npx markdownlint-cli "$file"
          done

  shellcheck:
    name: Run shellcheck
    runs-on: ubuntu-latest
    steps:
      # コミットをチェックアウト
      - name: Checkout the commit
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      # shellcheckを実行
      - name: Run shellcheck
        uses: ludeeus/action-shellcheck@2.0.0

  publish:
    name: Publish to blog
    runs-on: ubuntu-latest
    needs: [textlint, markdownlint, shellcheck]
    steps:
      # コミットをチェックアウト
      - name: Checkout the commit
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 100

      # 変更されたMarkdownファイルを検出
      - name: Get changed markdown files
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          files: |
            kiririmode.hatenablog.jp/entry/[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]/*.md

      # blogsyncをセットアップ（変更があった場合のみ）
      - name: Setup blogsync
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          BLOGSYNC_VER: v0.20.1
        run: |
          mkdir bin
          curl \
            --location \
            --output blogsync.tar.gz \
            --remote-name \
            https://github.com/x-motemen/blogsync/releases/download/${BLOGSYNC_VER}/blogsync_${BLOGSYNC_VER}_linux_amd64.tar.gz
          tar zxf blogsync.tar.gz -C bin --strip-component 1 blogsync_${BLOGSYNC_VER}_linux_amd64/blogsync

      # blogsyncのパスをPATHに追加（変更があった場合のみ）
      - name: append blogsync path to PATH
        if: steps.changed-files.outputs.any_changed == 'true'
        run: echo "./bin" >> $GITHUB_PATH

      # blogsync設定ファイルを作成（変更があった場合のみ）
      - name: Create blogsync config
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          cat > blogsync.yaml << 'EOF'
          kiririmode.hatenablog.jp:
            default:
              local_root: ./
          EOF

      # 変更されたエントリを公開
      - name: Post changed entries
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          TZ: "Asia/Tokyo"
          BLOGSYNC_USERNAME: ${{ secrets.USERNAME }}
          BLOGSYNC_PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          echo "Publishing changed entries..."
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Publishing: $file"
            bin/blogsync push "$file"
          done
